# 📊 خريطة تدفق نظام اختبارات القبول - مدارس الأنجال

**التاريخ:** 23 أكتوبر 2025  
**النسخة:** 3.1.0 - الإصدار المحدث

---

## 🎯 نظرة عامة على النظام

```
┌─────────────────────────────────────────────────────────────────────┐
│              نظام اختبارات القبول - مدارس الأنجال                  │
│                                                                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐           │
│  │  Owner   │  │  Super   │  │Supervisor│  │ Manager  │           │
│  │   (1)    │  │  Admin   │  │  (3-4)   │  │   (6)    │           │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘           │
│                                                                      │
│       ┌──────────┐                    ┌──────────┐                 │
│       │ Teacher  │                    │ Student  │                 │
│       │  (10+)   │                    │  (100+)  │                 │
│       └──────────┘                    └──────────┘                 │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 **الفلو الأساسي للنظام (محدّث)**

```
┌─────────────────────────────────────────────────────────┐
│                   🎓 الطالب يسلم الاختبار               │
└────────────────────────┬────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│              👨‍🏫 المعلم يصحح الأسئلة                   │
│  • MCQ/True-False → تصحيح تلقائي فوري ✅               │
│  • Essay → تصحيح يدوي من المعلم                        │
│  • Oral → تصحيح يدوي من المعلم (من 5)                 │
└────────────────────────┬────────────────────────────────┘
                         ↓
             ✅ teacherGradingComplete = true
                         ↓
┌─────────────────────────────────────────────────────────┐
│          👨‍💼 مشرف المادة يراجع ويعتمد                 │
│  • يشوف كل أسئلة المادة اللي تحت إشرافه                │
│  • يقدر يعدل الدرجة الكلية للمادة (لو ضروري)          │
│  • يعتمد المادة أو يرجعها للمعلم                       │
└────────────────────────┬────────────────────────────────┘
                         ↓
      ✅ allSubjectsApproved = true (كل المواد اتعتمدت)
                         ↓
┌─────────────────────────────────────────────────────────┐
│          🏢 مدير المدرسة - الاعتماد النهائي            │
│  • يشوف النتيجة الكلية بعد اعتماد كل المواد            │
│  • يشوف درجات جميع المواد (بدون تعديل)                 │
│  • يتخذ قرار نهائي:                                    │
│    ✅ قبول (Approved)                                  │
│    ❌ رفض (Rejected)                                   │
│    ⚠️ قبول مشروط (Conditional)                        │
│  • يكتب ملاحظات (اختياري)                              │
└────────────────────────┬────────────────────────────────┘
                         ↓
              ✅ finalStatus = approved/rejected/conditional
                         ↓
┌─────────────────────────────────────────────────────────┐
│              📊 الطالب يشوف النتيجة النهائية            │
│  • لو pending → "قيد المراجعة"                         │
│  • لو approved → "مقبول ✅" + الدرجات                  │
│  • لو rejected → "غير مقبول ❌"                        │
│  • لو conditional → "قبول مشروط ⚠️" + الملاحظات       │
└─────────────────────────────────────────────────────────┘
```

---

## 🔐 **1. تسجيل الدخول (Authentication Flow)**

### 🔹 الموظفين (Staff Login)
```
START → http://localhost:3000/auth/staff
  ↓
┌──────────────────────────┐
│  إدخال رقم الهوية        │ ← 10 أرقام
│  إدخال كلمة المرور        │ ← Test@1234 أو مخصصة
└──────────────────────────┘
  ↓
┌──────────────────────────┐
│  التحقق من البيانات      │
│  • مطابقة رقم الهوية     │
│  • التحقق من كلمة المرور │
│  • جلب الدور (Role)      │
└──────────────────────────┘
  ↓
  ├─→ [خطأ] → رسالة خطأ + العودة للتسجيل
  │
  └─→ [صحيح] → إنشاء JWT Token
                  ↓
         ┌────────────────────┐
         │  توجيه حسب الدور  │
         └────────────────────┘
                  ↓
┌──────────┬──────────┬──────────┬──────────┬──────────┐
│  Owner   │  Super   │Supervisor│ Manager  │ Teacher  │
│          │  Admin   │          │          │          │
↓          ↓          ↓          ↓          ↓
/super-    /super-    /supervisor /manager  /teacher
admin      admin
```

### 🔹 الطلاب (Student Login)
```
START → http://localhost:3000/auth/student
  ↓
┌──────────────────────────┐
│  إدخال رقم الهوية        │ ← 10 أرقام
│  إدخال PIN              │ ← 4 أرقام
└──────────────────────────┘
  ↓
┌──────────────────────────┐
│  التحقق من البيانات      │
│  • مطابقة رقم الهوية     │
│  • التحقق من PIN         │
└──────────────────────────┘
  ↓
  ├─→ [خطأ] → رسالة خطأ + العودة
  │
  └─→ [صحيح] → إنشاء JWT Token
                  ↓
         /student/exam
```

---

## 👨‍🏫 **2. دورة المعلم (Teacher Flow)**

```
Teacher Login → /teacher
  ↓
┌─────────────────────────────────────────┐
│  لوحة التحكم - الأسئلة المعلقة          │
└─────────────────────────────────────────┘
  ↓
عرض الأسئلة التي تحتاج تصحيح:
• Essay Questions
• Oral Questions (بعد ما الطالب يضغط "أنا جاهز")
  ↓
┌─────────────────────────────────────────┐
│  تصحيح السؤال:                         │
│  • Essay: من 0 إلى [درجة السؤال]       │
│  • Oral: من 0 إلى 5 فقط ⚠️            │
│  • كتابة تعليق (اختياري)               │
│  [حفظ التصحيح]                         │
└─────────────────────────────────────────┘
  ↓
AttemptAnswer.manual_score = [الدرجة]
  ↓
هل كل الأسئلة اتصححت؟
  ├─→ لا → السؤال يبقى في القائمة
  │
  └─→ نعم → Attempt.teacherGradingComplete = true
             ↓
        يظهر للمشرف في قائمته
```

---

## 👨‍💼 **3. دورة المشرف (Supervisor Flow) - جديد!**

```
Supervisor Login → /supervisor
  ↓
┌─────────────────────────────────────────┐
│  لوحة التحكم - المواد المعلقة للاعتماد  │
│  (فقط المواد اللي تحت إشرافه)           │
└─────────────────────────────────────────┘
  ↓
عرض Attempts اللي:
• teacherGradingComplete = true
• الماده من مواد المشرف
• المادة لسه مش معتمدة
  ↓
┌─────────────────────────────────────────┐
│  مراجعة المادة:                        │
│  ┌───────────────────────────────────┐ │
│  │ الطالب: أحمد علي                 │ │
│  │ المادة: عربي                     │ │
│  │ الدرجة الأصلية: 85/100           │ │
│  │                                   │ │
│  │ هل تريد تعديل الدرجة؟            │ │
│  │ ☐ لا، اعتماد الدرجة كما هي       │ │
│  │ ☑ نعم، تعديل إلى: [___]/100     │ │
│  │                                   │ │
│  │ ملاحظات (اختياري):               │ │
│  │ [_________________________]       │ │
│  │                                   │ │
│  │ [اعتماد المادة]  [رفض/إرجاع]    │ │
│  └───────────────────────────────────┘ │
└─────────────────────────────────────────┘
  ↓
SubjectApproval.create({
  attemptId, subjectId, supervisorId,
  originalScore, adjustedScore, isApproved
})
  ↓
هل كل المواد اتعتمدت من المشرفين؟
  ├─→ لا → ينتظر باقي المشرفين
  │
  └─→ نعم → Attempt.allSubjectsApproved = true
             ↓
        يظهر للمدير في قائمة الاعتماد النهائي
```

---

## 🏢 **4. دورة المدير (Manager Final Approval)**

```
Manager Login → /manager
  ↓
┌─────────────────────────────────────────┐
│  تبويب: الاعتماد النهائي               │
│  (الطلاب اللي كل موادهم اتعتمدت)       │
└─────────────────────────────────────────┘
  ↓
عرض Attempts اللي:
• allSubjectsApproved = true
• finalStatus = 'pending'
• من مدرسة المدير
  ↓
┌─────────────────────────────────────────────────────┐
│  الاعتماد النهائي:                                │
│  ┌─────────────────────────────────────────────┐   │
│  │ الطالب: أحمد علي                           │   │
│  │ المدرسة: بنات ابتدائي                     │   │
│  │ الصف: G4                                   │   │
│  │                                             │   │
│  │ ملخص الدرجات بعد اعتماد المشرفين:          │   │
│  │ ┌──────────┬────────┬────────┬────────┐    │   │
│  │ │ المادة   │ الأصلية│ المعدلة│ النهائية│   │   │
│  │ ├──────────┼────────┼────────┼────────┤    │   │
│  │ │ عربي     │   85   │   85   │   85   │    │   │
│  │ │ رياضيات  │   90   │   92   │   92   │    │   │
│  │ │ علوم     │   75   │   75   │   75   │    │   │
│  │ │ إنجليزي  │   88   │   88   │   88   │    │   │
│  │ └──────────┴────────┴────────┴────────┘    │   │
│  │                                             │   │
│  │ الدرجة الكلية: 340/400 (85%)              │   │
│  │                                             │   │
│  │ ⚠️ المدير لا يستطيع تعديل الدرجات         │   │
│  │    فقط اتخاذ قرار القبول/الرفض             │   │
│  │                                             │   │
│  │ القرار النهائي:                            │   │
│  │ ◉ ✅ قبول                                  │   │
│  │ ○ ❌ رفض                                   │   │
│  │ ○ ⚠️ قبول مشروط                           │   │
│  │                                             │   │
│  │ ملاحظات (إلزامية للرفض/القبول المشروط):   │   │
│  │ [___________________________________]       │   │
│  │                                             │   │
│  │ [اعتماد القرار]                            │   │
│  └─────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
  ↓
Attempt.update({
  finalStatus: 'approved' | 'rejected' | 'conditional',
  finalApprovedBy: managerId,
  finalApprovedAt: Date.now(),
  managerNotes: notes
})
  ↓
النتيجة تظهر للطالب فوراً
```

---

## 👨‍🎓 **5. دورة الطالب (Student Results Flow)**

```
Student Login → /student/exam
  ↓
إجراء الاختبار → تسليم
  ↓
الذهاب إلى /student/results
  ↓
┌─────────────────────────────────────────────────────┐
│              📊 نتائج اختباراتي                    │
└─────────────────────────────────────────────────────┘
  ↓
لكل اختبار، يتم فحص:
  ↓
┌─────────────────────────────────────────┐
│  الحالة 1: قيد التصحيح 🔵              │
│  teacherGradingComplete = false        │
│  الرسالة: "⏳ قيد التصحيح من المعلم"   │
│  الدرجات: مخفية                        │
└─────────────────────────────────────────┘
  ↓
┌─────────────────────────────────────────┐
│  الحالة 2: قيد اعتماد المشرف 🟡        │
│  teacherGradingComplete = true         │
│  allSubjectsApproved = false           │
│  الرسالة: "⏳ قيد الاعتماد من المشرف"  │
│  الدرجات: مخفية                        │
└─────────────────────────────────────────┘
  ↓
┌─────────────────────────────────────────┐
│  الحالة 3: قيد اعتماد المدير 🟠        │
│  allSubjectsApproved = true            │
│  finalStatus = 'pending'               │
│  الرسالة: "⏳ قيد الاعتماد النهائي"    │
│  الدرجات: مخفية                        │
└─────────────────────────────────────────┘
  ↓
┌─────────────────────────────────────────┐
│  الحالة 4: مقبول ✅                    │
│  finalStatus = 'approved'              │
│  الرسالة: "✅ مقبول - تهانينا!"        │
│  الدرجات: معروضة بالكامل               │
│  التقييم: معروض                        │
└─────────────────────────────────────────┘
  ↓
┌─────────────────────────────────────────┐
│  الحالة 5: غير مقبول ❌                │
│  finalStatus = 'rejected'              │
│  الرسالة: "❌ غير مقبول"               │
│  الدرجات: معروضة                       │
│  ملاحظات المدير: معروضة                │
└─────────────────────────────────────────┘
  ↓
┌─────────────────────────────────────────┐
│  الحالة 6: قبول مشروط ⚠️              │
│  finalStatus = 'conditional'           │
│  الرسالة: "⚠️ قبول مشروط"             │
│  الدرجات: معروضة                       │
│  الشروط (من ملاحظات المدير): معروضة   │
└─────────────────────────────────────────┘
```

---

## 📊 **6. جدول الصلاحيات (Permissions Matrix)**

| الدور | يصحح | يعتمد المادة | يعدل درجة المادة | يعتمد نهائي | يشوف كل الدرجات |
|-------|------|--------------|------------------|-------------|----------------|
| **Teacher** | ✅ موادهمفقط | ❌ | ❌ | ❌ | ❌ |
| **Supervisor** | ❌ | ✅ موادهم فقط | ✅ درجة المادة الكلية فقط | ❌ | ✅ موادهم فقط |
| **Manager** | ❌ | ❌ | ❌ | ✅ طلاب مدرسته | ✅ كل المواد (قراءة فقط) |
| **Super Admin** | ✅ | ✅ | ✅ | ✅ | ✅ |
| **Owner** | ✅ | ✅ | ✅ | ✅ | ✅ |

---

## 🗂️ **7. Models المحدثة**

### Attempt Model (محدث)
```typescript
{
  studentId: ObjectId,
  examId: ObjectId,
  
  // Teacher Status
  teacherGradingComplete: boolean, // المعلم خلص التصحيح
  
  // Supervisor Status
  allSubjectsApproved: boolean, // كل المواد اتعتمدت
  
  // Manager Status  
  finalStatus: 'pending' | 'approved' | 'rejected' | 'conditional',
  finalApprovedBy: ObjectId, // Manager ID
  finalApprovedAt: Date,
  managerNotes: string
}
```

### SubjectApproval Model (جديد)
```typescript
{
  attemptId: ObjectId,
  subjectId: ObjectId,
  supervisorId: ObjectId,
  originalScore: number, // الدرجة الأصلية
  adjustedScore: number, // الدرجة المعدلة (اختياري)
  maxScore: number,
  isApproved: boolean,
  notes: string,
  approvedAt: Date
}
```

### SupervisorAssignment Model (موجود)
```typescript
{
  supervisorId: ObjectId,
  subjectId: ObjectId // المادة اللي المشرف مسؤول عنها
}
```

---

## 🔄 **8. الفلو الكامل - خطوة بخطوة**

```
┌────────────────────────────────────────────────────────────┐
│ 1. الطالب يبدأ ويسلم الاختبار                             │
│    POST /api/attempts/start                                │
│    POST /api/attempts/submit                               │
│    → Attempt.isCompleted = true                            │
└────────────────────────────────────────────────────────────┘
                         ↓
┌────────────────────────────────────────────────────────────┐
│ 2. التصحيح التلقائي يشتغل فوراً                           │
│    • MCQ/True-False → autoScore محسوب                     │
│    • Essay/Oral → manual_score = null (معلق)              │
└────────────────────────────────────────────────────────────┘
                         ↓
┌────────────────────────────────────────────────────────────┐
│ 3. المعلم يصحح الأسئلة اليدوية                            │
│    GET /api/teacher/pending → جلب الأسئلة المعلقة          │
│    POST /api/teacher/grade → حفظ الدرجة                   │
│    → AttemptAnswer.manual_score = [درجة]                  │
└────────────────────────────────────────────────────────────┘
                         ↓
┌────────────────────────────────────────────────────────────┐
│ 4. النظام يفحص: هل كل الأسئلة اتصححت؟                    │
│    إذا نعم:                                               │
│    → Attempt.teacherGradingComplete = true                │
│    → حساب درجة كل مادة                                    │
└────────────────────────────────────────────────────────────┘
                         ↓
┌────────────────────────────────────────────────────────────┐
│ 5. المشرف يراجع ويعتمد كل مادة                            │
│    GET /api/supervisor/pending → مواده فقط                │
│    POST /api/supervisor/approve → اعتماد المادة           │
│    → SubjectApproval.create({...})                        │
└────────────────────────────────────────────────────────────┘
                         ↓
┌────────────────────────────────────────────────────────────┐
│ 6. النظام يفحص: هل كل المواد اتعتمدت؟                    │
│    إذا نعم:                                               │
│    → Attempt.allSubjectsApproved = true                   │
│    → حساب الدرجة النهائية (مع التعديلات)                  │
└────────────────────────────────────────────────────────────┘
                         ↓
┌────────────────────────────────────────────────────────────┐
│ 7. المدير يعتمد النتيجة النهائية                          │
│    GET /api/manager/approvals → طلاب مدرسته فقط           │
│    POST /api/manager/final-approve → القرار النهائي        │
│    → Attempt.finalStatus = approved/rejected/conditional  │
└────────────────────────────────────────────────────────────┘
                         ↓
┌────────────────────────────────────────────────────────────┐
│ 8. الطالب يشوف النتيجة النهائية                           │
│    GET /api/student/results                                │
│    → عرض الحالة + الدرجات (إذا approved)                  │
└────────────────────────────────────────────────────────────┘
```

---

## 🎯 **9. الخلاصة**

### الأدوار الستة:
1. **👑 Owner** - كل الصلاحيات
2. **🎖️ Super Admin** - كل الصلاحيات (إلا Owner management)
3. **👔 Manager** - الاعتماد النهائي لمدرسته فقط
4. **👨‍💼 Supervisor** - اعتماد المواد (موادهم فقط + تعديل درجة المادة)
5. **👨‍🏫 Teacher** - التصحيح (موادهم فقط)
6. **👨‍🎓 Student** - إجراء الاختبارات وعرض النتائج

### مراحل النتيجة:
1. ⏳ **قيد التصحيح** (teacherGradingComplete = false)
2. ⏳ **قيد اعتماد المشرف** (allSubjectsApproved = false)
3. ⏳ **قيد الاعتماد النهائي** (finalStatus = pending)
4. ✅ **مقبول** (finalStatus = approved)
5. ❌ **مرفوض** (finalStatus = rejected)
6. ⚠️ **قبول مشروط** (finalStatus = conditional)

---

**🎉 نظام متكامل مع 3 مستويات اعتماد!**

**المطور:** Claude AI Assistant  
**التاريخ:** 23 أكتوبر 2025  
**النسخة:** 3.1.0  
**الحالة:** ✅ موثّق ومحدّث

---

© 2025 مدارس الأنجال الأهلية والدولية  
قسم الحاسب الآلي - إشراف: أستاذ هشام يسري
